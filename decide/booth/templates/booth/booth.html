{% load static%} {% load i18n %} {% load rest_framework %}
<!DOCTYPE html>

{% block head %}

<head>
	<meta charset='utf-8'>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="{% static 'css/style.css' %}">
	<link href="//fonts.googleapis.com/css?family=Lobster&subset=latin,latin-ext" rel="stylesheet" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</head>
<div class="text-center">
	<div class="container-fluid bg-primary text-white py-3">
		<div class="container">
			<h1 class="display-3">
				<b class="fuente">Cabina de votación</b>
			</h1>
		</div>
	</div>
	<p class="lead bg-info text-white">Selecciona tu respuesta para
		esta votación</p>
</div>
{% endblock %}
{% block extrahead %}
<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
<link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />
<link type="text/css" rel="stylesheet" href="{% static 'booth/style.css' %}" />
{% endblock %}
{% block content %}

<body id="bg" style="background-image: url('{%static "img/blanco.jpg"%}');">
	<link rel="stylesheet" href="{% static 'css/style.css' %}">
	<div class="text-center">
		<h1 style="left: 0; display: inline;">{{ voting_id }} - {{ name }}</h1>
		<div id="voting">

			{% if voted %}
			<p class="lead">Usted ya ha votado</p>
			{% else %} {% if start_date == None%}
			<p>La votación no ha empezado aún</p>

			{%else%}
			<p>La votación empezó el: {{ start_date }}</p>
		</div>
		<div class="text-center">
			{% if question.yesorno %}
			<h2>{{question.yesorno}}</h2>
			<h3>{{desc}}</h3>


			<form>
				<fieldset>
					<legend>Elige una respuesta</legend>
					<label>
						<input v-model="selected" type="radio" name="yon"
							value="{{question.options.y}}">{{question.options.y}}
					</label>
					<label>
						<input v-model="selected" type="radio" name="yon"
							value="{{question.options.n}}">{{question.options.n}}
					</label>
				</fieldset>
			</form>


			<div class="mt-3">Selected: <strong>{{ selected }}</strong></div>

			<a href="{% url 'hasVotado' %}" class="btn btn-success" v-on:click="decideSend()">{% trans "Vote" %}</a>
			{%endif%}
		</div>
		<div class="text-center">
			{% if question.multiple %}
			<h2>{{question.multiple}}</h2>
			<h3>{{desc}}</h3>
			{% for o in question.options %}
			<label for="question{{options.number}}">
				<input class="button buttonseveral" type="submit" name="question" value="{{question.options.o}}" />
				<div class="guideAnswer divGuide" style="margin:20px;padding:20px;">
					{% trans "Answer"%} {{question.options.o}}
				</div>
			</label>
			{%endfor%}
			{%endif%}
		</div>

		{%if end_date == None%}
		<p>Aún puede votar, no ha finalizado la votación</p>
		{% else %}
		<p>Ya no puede votar, la votación se cerró el: {{ end_date }}</p>
		{% endif %}

		{% endif %}
		{% endif %}
	</div>
</body>
{% endblock %}
{% block extrabody %}
<!-- needed to generate big random -->
<script src="{% static "crypto/sjcl.js" %}"></script>

<!-- Big integer -->
<script src="{% static "crypto/jsbn.js" %}"></script>
<script src="{% static "crypto/jsbn2.js" %}"></script>
<script src="{% static "crypto/bigint.js" %}"></script>

<!-- ElGamal encrypt -->
<script src="{% static "crypto/elgamal.js" %}"></script>

<!-- Vuejs -->
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>

<script>
	var voting = {{voting| safe}};
	var app = new Vue({
		delimiters: ['[[', ']]'],
		el: '#app-booth',
		data: {
			keybits: {{KEYBITS}},
	voting: voting,
		selected: "",
			signup: true,
				alertShow: false,
					alertMsg: "",
						alertLvl: "info",
							token: null,
								user: null,
									form: {
		username: '',
			password: ''
	},
	bigpk: {
		p: BigInt.fromJSONObject(voting.pub_key.p.toString()),
			g: BigInt.fromJSONObject(voting.pub_key.g.toString()),
				y: BigInt.fromJSONObject(voting.pub_key.y.toString()),
                }
            },
	beforeMount() {
		this.init()
		ElGamal.BITS = this.keybits;
	},
	methods: {
		init() {
			var cookies = document.cookie.split("; ");
			cookies.forEach((c) => {
				var cs = c.split("=");
				if (cs[0] == 'decide' && cs[1]) {
					this.token = cs[1];
					this.getUser();
				}
			});
		},
		postData(url, data) {
			// Default options are marked with *
			var fdata = {
				body: JSON.stringify(data),
				headers: {
					'content-type': 'application/json',
				},
				method: 'POST',
			};

			if (this.token) {
				fdata.headers['Authorization'] = 'Token ' + this.token;
			}

			return fetch(url, fdata)
				.then(response => {
					if (response.status === 200) {
						return response.json();
					} else {
						return Promise.reject(response.statusText);
					}
				});
		},
		onSubmitLogin(evt) {
			evt.preventDefault();
			this.postData("{% url "gateway" "authentication" " / login / " %}", this.form)
				.then(data => {
					document.cookie = 'decide=' + data.token + ';';
					this.token = data.token;
					this.getUser();
				})
				.catch(error => {
					this.showAlert("danger", '{% trans "Error: " %}' + error);
				});
		},
		getUser(evt) {
			var data = {token: this.token};
			this.postData("{% url "gateway" "authentication" " / getuser / " %}", data)
				.then(data => {
					this.user = data;
					this.signup = false;
				}).catch(error => {
					this.showAlert("danger", '{% trans "Error: " %}' + error);
				});
		},
		decideLogout(evt) {
			evt.preventDefault();
			var data = {token: this.token};
			this.postData("{% url "gateway" "authentication" " / logout / " %}", data);
			this.token = null;
			this.user = null;
			document.cookie = 'decide=;';
			this.signup = true;
		},
		decideEncrypt() {
			var bigmsg = BigInt.fromJSONObject(this.selected.toString());
			var cipher = ElGamal.encrypt(this.bigpk, bigmsg);
			return cipher;
		},
		decideSend(evt) {
			evt.preventDefault();
			var v = this.decideEncrypt();
			var data = {
				vote: {a: v.alpha.toString(), b: v.beta.toString()},
				voting: this.voting.id,
				voter: this.user.id,
				token: this.token
			}
			this.postData("{% url "gateway" "store" " / " %}", data)
				.then(data => {
					this.showAlert("success", '{% trans "Conglatulations. Your vote has been sent" %}');
				})
				.catch(error => {
					this.showAlert("danger", '{% trans "Error: " %}' + error);
				});
		},
		showAlert(lvl, msg) {
			this.alertLvl = lvl;
			this.alertMsg = msg;
			this.alertShow = true;
		}
	},
        })
</script>
{% endblock %}